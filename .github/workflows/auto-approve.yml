name: Auto-approve own PRs
on:
  issue_comment:
    types: [created]

jobs:
  auto-approve:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug - Show event data
        run: |
          echo "=== Event Debug Information ==="
          echo "Event action: ${{ github.event.action }}"
          echo "Comment body: '${{ github.event.comment.body }}'"
          echo "Issue number: ${{ github.event.issue.number }}"
          echo "Issue URL: ${{ github.event.issue.html_url }}"
          echo "Commenter: ${{ github.event.comment.user.login }}"
          echo "Repository owner: ${{ github.repository_owner }}"
          echo "Is PR: ${{ github.event.issue.pull_request != null }}"
          echo "PR URL: ${{ github.event.issue.pull_request.url }}"
          echo "Event name: ${{ github.event_name }}"

      - name: Check comment and approve PR
        id: approve
        run: |
          set -e
          
          COMMENT_BODY=$(echo "${{ github.event.comment.body }}" | xargs)
          PR_NUMBER="${{ github.event.issue.number }}"
          REPO="${{ github.repository }}"
          
          echo "=== Processing Comment ==="
          echo "Comment body (trimmed): '$COMMENT_BODY'"
          echo "PR number: $PR_NUMBER"
          
          # Check if this is a PR (not just an issue)
          if [ -z "${{ github.event.issue.pull_request.url }}" ]; then
            echo "❌ This is not a pull request comment. Skipping."
            exit 0
          fi
          
          # Validate it's the repository owner
          if [ "${{ github.event.comment.user.login }}" != "${{ github.repository_owner }}" ]; then
            echo "❌ Commenter (${{ github.event.comment.user.login }}) is not repository owner (${{ github.repository_owner }}). Skipping."
            exit 0
          fi
          
          # Check if comment matches
          if [ "$COMMENT_BODY" != "APPROVED" ]; then
            echo "❌ Comment does not match 'APPROVED' (received: '$COMMENT_BODY'). Skipping."
            exit 0
          fi
          
          echo "✅ Conditions met. Proceeding to approve PR #$PR_NUMBER"
          
          # Use PAT if available, otherwise use GITHUB_TOKEN (but warn it won't bypass protection)
          # IMPORTANT: Only GH_PAT can bypass branch protection requirements
          TOKEN="${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}"
          
          if [ "${{ secrets.GH_PAT != '' }}" = "true" ]; then
            echo "✅ Using PAT for approval (will bypass branch protection)"
          else
            echo "⚠️  WARNING: GH_PAT secret not found!"
            echo "⚠️  Using GITHUB_TOKEN will NOT bypass branch protection requirements"
            echo "⚠️  To bypass branch protection, create a Personal Access Token and add it as secret 'GH_PAT'"
          fi
          
          # Approve using GitHub API
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/reviews" \
            -d "{\"event\":\"APPROVE\",\"body\":\"Auto-approved by workflow\"}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "API Response Code: $HTTP_CODE"
          echo "API Response Body: $BODY"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "✅ PR #$PR_NUMBER approved successfully"
            echo "approved=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Failed to approve PR. HTTP Code: $HTTP_CODE"
            echo "$BODY"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}